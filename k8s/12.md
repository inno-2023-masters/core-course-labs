# Kubernetes ConfigMaps

## ConfigMap File import
I used configmap for `k8s/app-python` chart.
Config file location is `k8s/app-python/files/config.json`.

1. I created `k8s/app-python/templates/configmap.yaml` file:
    ```yaml
    apiVersion: v1

    kind: ConfigMap

    metadata:
      name: configmap
      labels:
        {{- include "app-python.labels" . | nindent 4 }}
    data:
      config.json: |-
    {{ .Files.Get "files/config.json" | indent 4 }}
    ```
2. I have added volume and volumeMounts to deployment:
    ```yaml
    volumes:
      - name: config-volume
        configMap:
          name: configmap
    volumeMounts:
      - name: config-volume
        mountPath: "/app/config.json"
        subPath: config.json
    ```
3. Also, I had to regenerate my secret key (the previous version had been broken), so the file `k8s/secrets.yaml` has been changed.
4. Finally, I can install release:
    ```shell
    helm secrets install app-python-release ./app-python -f ./secrets.yaml
    ```
5. Let's check configmap
    * ```shell
      kubectl get configmaps
      ```
      <u>Output:</u>
      ```text
      NAME               DATA   AGE
      configmap          1      8m43s
      kube-root-ca.crt   1      29h
      ```

    * ```shell
      kubectl describe configmaps configmap
      ```
      <u>Output:</u>
      ```text
      Name:         configmap
      Namespace:    default
      Labels:       app.kubernetes.io/instance=app-python-release
      app.kubernetes.io/managed-by=Helm
      app.kubernetes.io/name=app-python
      app.kubernetes.io/version=1.16.0
      helm.sh/chart=app-python-0.1.0
      Annotations:  meta.helm.sh/release-name: app-python-release
      meta.helm.sh/release-namespace: default

      Data
      ====
      config.json:
      ----
      {
          "auth": {
              "required": true,
              "username": "admin",
              "password": "admin",
              "access": {
                  "path": "**/*"
              }
          }
      }

      BinaryData
      ====

      Events:  <none>
      ```
6. Let's check volume mount
    * ```shell
      kubectl get po 
      ```
      <u>Output:</u>
      ```text
      NAME                                  READY   STATUS    RESTARTS   AGE
      app-python-release-84b99f659b-ch7r8   1/1     Running   0          14m
      app-python-release-84b99f659b-flhzc   1/1     Running   0          14m
      ```
    * ```shell
      kubectl exec app-python-release-84b99f659b-ch7r8 -- cat /config.json
      ```
      <u>Output:</u>
      ```text
      {
          "auth": {
              "required": true,
              "username": "admin",
              "password": "admin",
              "access": {
                  "path": "**/*"
              }
          }
      }%
      ```
      
## ConfigMap Env Variable import
1. Let's add `envFrom`
    ```yaml
    envFrom:
    - configMapRef:
      name: configmap
    ```
2. Then, let's install the chart
    ```shell
    helm secrets install app-python-release ./app-python -f ./secrets.yaml
    ```
3. Let's get environment variable
   * ```shell
     kubectl get po
     ```
      <u>Output:</u>
      ```text
      NAME                                 READY   STATUS    RESTARTS   AGE
      app-python-release-7d64d874b-82w29   1/1     Running   0          6m38s
      app-python-release-7d64d874b-lzx4m   1/1     Running   0          6m38s
      ```
  * ```shell
      kubectl exec app-python-release-7d64d874b-82w29 -- printenv "config.json"
      ```
    <u>Output:</u>
    ```text
    {
        "auth": {
            "required": true,
            "username": "admin",
            "password": "admin",
            "access": {
                "path": "**/*"
            }
        }
    }
    ``` 
